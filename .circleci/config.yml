version: 2
jobs:
  build:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    steps:
      - checkout
      - run:
          name: update
          command: 'apt-get update -qq'
      - run:
          name: build-essential
          command: 'apt-get -y install build-essential'
      - run:
          name: dependencies
          command: 'apt-get -y install rpm libncurses-dev cmake clang g++ wget git libssl-dev bc patch libedit-dev libelf-dev'
      - run:
          name: prepare
          command: 'cd ./v0.3.10 && make prepare'
      - run:
          name: config
          command: 'cd ./v0.3.10 && make config_circle'
      - run:
          name: rpm
          command: 'cd ./v0.3.10 && make rpm'
          no_output_timeout: 3600
      - run:
          name: move
          command: 'cd ./v0.3.10 && make move'
      - run:
          name: ruby
          command: 'apt-get -y install ruby2.3 ruby2.3-dev'
      - run:
          name: rake
          command: 'gem install rake'
      - run:
          name: package_cloud
          command: 'gem install package_cloud'
      - deploy:
          name: publish
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              cd ./v0.3.10 && make publish
            fi
